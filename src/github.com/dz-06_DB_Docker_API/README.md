# ДЗ 6

[Вернуться на Главную страницу](../../../README.MD)

Дисциплина	Программирование на Golang

Тема 8. Работа с базами данных в Golang


## Описание задания

Цель: дополнить веб-сервис обработки транзакций (домашнее задание 5) функциональностью для работы с базой данных.

Требования к программе: обеспечить сохранение данных о пользователях и их транзакциях в БД, реализовать CRUD-операции для управления этими данными через RESTful API.

### Шаг 1. Запуск локальной БД

Если у вас уже установлена какая либо БД и вы можете к ней подключиться, то пропустите этот этап.
Установите Docker Compose и DBeaver. Создайте файл docker-compose.yml в корне вашего проекта с следующим содержанием:

``` yaml
version: ‘3.1’

services:
db:
image: postgres:latest
restart: always
environment:
POSTGRES_DB: transactionsdb
POSTGRES_USER: user
POSTGRES_PASSWORD: password
ports:
- "5432:5432"
volumes:
- ./data/db:/var/lib/postgresql/data
```

Запустите контейнер из корневого каталога вашего проекта командой:
docker-compose up -d

Для остановки контейнера используйте:
docker-compose down

Используйте учётные данные из вашего файла docker-compose.yml (POSTGRES_USER, POSTGRES_PASSWORD и имя базы данных POSTGRES_DB) для подключения к базе данных из веб-приложения.
Подключение можно осуществить с помощью программы DBeaver.

Проверьте, что создание БД прошло успешно и вы подключились, и переходите к следующему шагу.

### Шаг 2. Подключение к БД

Используйте драйвер pg и стандартную библиотеку database/sql, чтобы подключиться к БД из приложения. После этого попробуйте реализовать тестовые CRUD-операции, чтобы убедиться, что данные в БД создаются и подтягиваются в приложение.

### Шаг 3. Реализация таблиц в БД

Реализуйте следующие таблицы в БД.

**Пользователь (User):**

- ID (уникальный идентификатор),
- имя,
- электронная почта,
- пароль (хранение в зашифрованном виде).

**Транзакция (Transaction):**
- ID (уникальный идентификатор);
- ID пользователя (связь с таблицей пользователей);
- сумма;
- валюта: USD, EUR и т. д.;
- тип: доход, расход, перевод;
- категория: зарплата, еда, жильё и т. д.;
- дата;
- описание.

### Шаг 4. Реализация основных CRUD-операций

Реализуйте основные CRUD-операции по работе с БД. Предварительно заполните таблицу User тестовыми данными. Если вы пропускаете часть с дополнительным заданием, то информацию о пользователе (UserID) нужно передавать в каждом Request для всех методов из нижеприведённого списка. Если вы выполнили дополнительное задание, то вместе с запросом нужно передать JWT-токен, из которого при парсинге Request следует достать ID пользователя.

- Создание транзакции: POST /transactions.
- Добавление новой транзакции для пользователя с сохранением в БД.
- Получение списка всех транзакций пользователя: GET /transactions.
- Возврат списка транзакций для пользователя.
- Получение одной транзакции по ID: GET /transactions/{id}.
- Возврат деталей конкретной транзакции по её ID для пользователя.
- Обновление транзакции по ID: PUT /transactions/{id}.
- Обновление данных транзакции по её ID для пользователя.
- Удаление транзакции по ID: DELETE /transactions/{id}.
- Удаление транзакции по её ID для пользователя.

```bash
#Request
curl -X POST http://localhost:8080/transactions \
-H "Token:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTA1MTM3MzQsInVzZXJfaWQiOjR9.D7YnMNY6o-07cJ37oUciISumH_WBv97FZFQNPG7k9so" \
-H "Content-Type: application/json" \
-d '{
    "user_id": 4,
    "amount": 100.50,
    "currency": "USD",
    "type": "expense",
    "category": "Food",
    "date": "2023-03-13T14:00:00Z",
    "description": "Lunch at restaurant"
}'

#Responce:
{"id":1,"user_id":4,"amount":100.5,"currency":"USD","type":"expense","category":"Food","date":"2023-03-13T14:00:00Z","description":"Lunch at restaurant"}
```

### Дополнительное задание (необязательное)- не реализовано

Реализуйте аутентификацию пользователя.
- Создание пользователя: POST /users.
- Регистрация нового пользователя с сохранением информации в БД.
- Аутентификация пользователя: POST /users/login.
- Проверка электронной почты и пароля пользователя, возвращение токена аутентификации.

Далее проверяйте токен при каждом запросе на ваш веб-сервис, чтобы убедиться, что пользователь существует и логин и пароль введены корректно.

```bash
# Регистрация пользователя
curl -X POST http://localhost:8080/users -H "Content-Type: application/json" -d '{"name":"John Doe", "email":"john.doe1@example.com", "password":"passwd01"}'

# Аутентификация пользователя
curl -vv -X POST http://localhost:8080/users/login -H "Content-Type: application/json" -d '{"email":"john.doe1@example.com", "password":"passwd01"}'

Response:
< HTTP/1.1 200 OK
< Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTA1MTM3MzQsInVzZXJfaWQiOjR9.D7YnMNY6o-07cJ37oUciISumH_WBv97FZFQNPG7k9so
< Date: Fri, 13 Mar 2024 14:12:14 GMT
< Content-Length: 0

```

### Шаг 5. Тестирование
Используйте Postman или cURL для тестирования разработанных эндпоинтов.
Пример работы программы

    Создание транзакции:
```yaml
    Request: POST /transactions {
    “userID”: 1,
    “amount”: 200,
    “currency”: “USD”,
    “type”: “expense”,
    “category”: “Еда”,
    “date”: “2024-03-16”,
    “description”: “Обед в ресторане”
    }
    Response: 201 Created {
    “id”: “1”,
    “status”: “Success”
    }

```

**Примечания:**

- При разработке структуры API стремитесь к простоте и понятности. Используйте принципы RESTful, чтобы обеспечить чистоту и лёгкость в расширении API.
- В качестве СУБД можно использовать любую удобную для вас, например, PostgreSQL, MySQL, MongoDB.
- Для упрощения разработки и тестирования можно использовать ORM- (object-relational mapping), такие как GORM для Golang.

## Чек-лист самопроверки

Наименование критерия	Да/нет

    Установлены Docker Compose и DBeaver
    Файл docker-compose.yml добавлен в корень вашего веб-сервиса (ДЗ 5)
    Выполнена команда для запуска контейнера и статус контейнера Up (команда для проверки статуса: docker ps -a)
    Выполнено подключение к БД через любой обозреватель БД, например DBeaver
    Таблицы транзакций и пользователей созданы
    Реализованы CRUD-операции по работе с БД
    Протестированы эндпоинты: cURL или Postman
    В поле ответа в личном кабинете прикреплена ссылка на код в GitHub

